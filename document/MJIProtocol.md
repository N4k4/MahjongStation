# MJProtocol
version:0.0.0

last update:2022/07/09

author:Naka

## これは何？
MahJong Interface Protocol(以下、MJIと略記)は、MahjongStationと思考エンジンの間でやり取りをするプロトコルとして策定されたものです。

コマンドの仕様設計について、[USI](http://shogidokoro.starfree.jp/usi.html)及び[USI-X](https://yaneuraou.yaneu.com/2022/06/07/standard-communication-protocol-for-games/)を強く参考にしています。



## なぜUSI-Xの拡張としなかったのか
プロトコルの策定段階では、USI-Xの純粋な拡張として設定する予定でした。
しかし、USI-Xの前身であるUSIは将棋向けに開発されており、その一部の仕様が麻雀との親和性が悪いと考えました。麻雀をするうえでより自然な情報のやり取りを行うために、新たなプロトコルを設定することとしました。

例えば、将棋はルールが既に確立されている一方、麻雀ではメジャールールでも複数バリエーション、ローカルを合わせれば非常に多くの種類があります。それらのルールに対する拡張性に乏しいと考えました。
また、麻雀は対局という区切りだけでなく局の区切りも明確に分かれており、進行の面でも将棋との差異が大きいため新たなプロトコルを考えることとしました。

## ルールについて
[別ドキュメント](./MJRules.md)参照のこと。

ここで定義されたルールを実装することを考えます。

# 麻雀用語の英語訳
コマンドの命名の際、ローマ字表記のほかに英語圏で用いられる用語を参考にしているケースがあります。
[麻雀の英語版wikipedia](https://en.wikipedia.org/wiki/Mahjong)を参考にしています。

|日本語|英語|説明|
|-|-|-|
|対局|match|
|場|round|東場、南場などのこと。|
|局|hands|東一局、二局の局のこと|
|面子|meld|ラミーの用語に由来するらしい|
|刻子|pong|ポンの宣言時にも言う|
|槓子|kong|槓の宣言時にも言う|
|順子|chow|チーの宣言時にも言う|
|対子|eyes|pairと言われることもあるらしい|
|河|discard|
|山|wall|

## 牌の表現
MJIプロトコルにおける牌の表現は以下に従うものとします。

麻雀牌は英字1文字と数字1文字の二文字の組み合わせで表現します。

萬子、筒子、索子はそれぞれ`mx`,`px`,`sx`として、xには数牌の数字が入ります(例：３筒なら`p3`)。また、赤5牌は数字を0として表現します(例：赤五萬なら`m0`)

風牌は東南西北それぞれを、`w1`,`w2`,`w3`,`w4`と表します。wはwindから命名して、東を1としています。

三元牌は、白發中それぞれを、`d1`,`d2`,`d3`と表します。dは三元牌の英語表現のdragonから命名して、白を1としています。

また、自摸した直後の牌は牌の表現の前に`t`を付与します。赤五索をツモ切りする場合`ts0`と表現される牌を切ることになります(詳細は後述します)

## 手牌の表現
`tablestatus`コマンドなどで表現される手牌の表現は以下のように従います。

- 空白なく、手牌それぞれを表す牌の表現文字列を並べます
- 副露によって開いた牌は手牌の表現文字列には含めません。
- 萬子＞筒子＞索子＞風牌＞三元牌の順に並びます
- 数字が小さい順に並びます
    - 0番(赤牌)は先頭に来ます。
- 自摸牌は手牌文字列の一番最後に表示します


いかに手牌文字列例を載せます。

- 筒子1-9と萬子3-5,白一枚
    - m3m4m5p1p2p3p4p5p6p7p8p9d1
- 三索3枚,赤五筒,五筒2枚,4-6萬,東対子,中対子,自摸牌中
    - m4m5m6p0p5p5s3s3s3w1w1d3d3td3
- 白発中をポンして南と西を対子で持っているとき
    - w2w2w3w3
    - 副露した牌は表現に含めません。

## 動作の表現
`tablestatus`コマンドなどで表現される動作の表現は以下のように従います。

```
<userid>:<movetype>:<option>
```

まず最初に動作主の席次を提示します。

`<movetype>`でおこなった動作の種類を提示します。

`<option>`でその動作を表現する追加情報を提示します。

`<movetype>`の一覧は以下の通りです。

|`<movetype>`名|説明|`<option>`の説明|
|-|-|-|
|dahai|打牌|切った牌を表現。ツモ切りの際は牌の先頭にtをつけること|
|reach|立直|切った牌を表現|
|pong|ポン|自分の手牌のうち開く二牌を表現|
|dkong|暗槓|自分の手牌の開く４牌を表現|
|lkong|明槓|自分の手牌の開く3牌を表現|
|kkong|加槓|自分の手牌の付け加える牌を表現|
|chow|チー|自分の手牌の開く二牌を表現|
|tsumoagari|ツモ和了り。|なし|
|ron|ロン|なし|
|none|何もしない。`bestmove`コマンドのみ|なし|
|nuki|ドラ抜き(未実装)|抜く牌を表現|

以下に例を提示します。


## データのやり取りについて
仕様定義にあたってのドラフトです。

エンジン起動時、対局開始前、局の開始前(局と局の間を含む)、対局中、対局終了後の５ステップに分けて考えます。

### エンジン起動時

GUIソフトと、MJIプロトコルエンジンの間でのやりとりを開始する。
自身のエンジンで設定されているオプションを送付して、自分がMJIプロトコルを採用したエンジンであることを伝達します。


### 対局開始前

エンジン毎に設定されるオプションをGUIソフト側から設定します。

対戦の開始前準備が宣言されると、設定されたゲームにおける複数のオプションをエンジン側に伝達します。

最後に自身の着席位置の伝達とともに対局準備完了を問い合わせます。

エンジン側は対応不可能なオプションを検出した場合は対戦拒否を宣言できます。


対応可能であれば対局準備完了を宣言します。


### 局の開始前(局と局の間を含む)

現在のそれぞれの点数、次の局の場(東南)と第何局か、何本場かをそれぞれのプレイヤーに宣言します。
そして、各エンジンに局開始の準備ができているかを問い合わせます。

各エンジンは情報を取得して確認出来たら局開始準備ができていることを宣言します。



### 対局中

自摸番が来た時、局の状況(ドラ、河や副露の情報など)と自身の手牌と自摸牌、残り時間などがコマンドとして与えられます。

これに対して、牌を切る、リーチを宣言する、暗槓・加槓を宣言する、自摸和了を宣言するなど、自分の手番で行える動作をコマンドで宣言します。

ツモ番の人が動作を行った後、ほかのプレイヤーはその動作を行った直後の局の状況を受け取ります。
行える動作があるときはそれに対する動作を宣言します。
ここでの動作は、ロン和了り、搶槓でのロン和了り、ポン、槓、チーなどの発声動作を指します。この時、動作をしない場合も動作をしないことを宣言する必要があります。

動作に応じて、適切な人に次の手番が回ってきます。暗槓・加槓であれば同じ人に、ポンカンチーであれば発声者に、それ以外であれば右隣の人に回ってきます。

ここまでの流れを一回のツモ番で行い、これを繰り返します。


### 対局終了後

対局が終了したことと、プレイヤーの着順、それぞれのプレーヤーの点棒、それぞれのプレーヤーのウマ・オカを含めた最終スコアを宣言して終了



# コマンド定義
ここからは、MJIプロトコルで利用される具体的なコマンドを定義します。一部、拡張における仕様が定義されている場合もあります。

## GUIからエンジンに送られるコマンド

### `mji`
```
mji
```
エンジンが起動した直後に送られるコマンドです。エンジンはこれを受け取ったらすぐに`id`コマンドを返します。必要に応じて`option`コマンドを返し、最後に`mjiok`コマンドを送る必要があります。

### `setoption`
```
setoption name <id> value <x>
```
エンジンのオプションをGUI側から設定するためのオプションです。

`<id>`で指定する名前は、エンジンが起動時に`option`コマンドで返した名前になります。
`value <x>`で、`setoption`時に指定されたタイプの値を返します。

ただし、オプションにはMJIプロトコルで予約されたオプションがいくつか定義されています。

**ここにMJIプロトコル予約オプションの定義が入ります。**

### `matchsetup`
```
matchsetup
```
ゲームの準備を開始することを宣言します。
このコマンドに続けてゲームの設定を`matchrule`コマンドで宣言します。最後に`isready`コマンドを送ってエンジン側の返答を待ちます。
`matchsetup`が送られた後に送られた`matchrule`コマンドのみ有効です。それまでに送られていたコマンドは無視してください。

### `matchrule`
```
matchrule name <id> value <x>
```
対局における様々なルールをエンジン側に伝達します。

**ここに具体的なルールを説明する部分が入る**


### `isready`
```
isready <position>
```
エンジンに、準備ができたかどうかを問い合わせます。

`<position>`の型はintで、起家を1として、反時計回りにエンジンの着席位置を伝えます。(1始まりとしているのは、第n局の時の親の位置とnが一致するためです)

準備ができた場合は`readyok`コマンドを、対応できないゲームルールが採用されているために対戦を拒否する場合は`readyng`コマンドを送付します



### `newmatch`
```
newmatch
```
新しい対局を始めることを宣言します。

### `newhand`
```
newhand round <rounds> hand <hands> stack <stacks> points1 <points1> points2 <points2> ...
```
新しい局を始めることを宣言します。同時に、始まる局の情報も伝達します。

`<rounds>`は場を表します。東場を1として、場が進むごとに1加算されます。

`<hands>`は局を表します。第一局を1として、局が進むごとに1加算されます。連荘時には加算されません。

`<stacks>`は積み棒(本場)を表します。初期状態を0として、連荘などで本場が増えるごとに1加算されます。

`<pointsi>`は、プレイヤーiの点数を表します。この値は負の整数値となることがあります。

### `tablestatus`
```
tablestatus doraind <doraIndicatorString> tehai <tehaiString> moves <move1> <move2> ... <movei> 
```

局の状況を提示するコマンドです。

`<doraIndicatorString>`はドラ表示牌を提示します。

`<tehaiString>`はプレイヤーの手牌を表示します。

`<movei>`は、局の中での行動が文字列で表現されています。この文字列をたどることで盤面の河や副露の状況を復元することができます。

この状況が思考開始局面になります。

### `go`
```
go <type> [<options>]
```

思考開始をエンジンに指示します。エンジンはこのコマンドを受けたら時間内に`bestmove`コマンドで自身の動作を指示します。
直前に`tablestatus`コマンドが発行されているので、この状況で思考をしてください。

このコマンドには複数のオプションが設定されています。以下にオプションを提示します。

#### `go turn`
```
go turn <timeoptions>
```
自分の手番の思考開始を指示します。自分のツモ番や、嶺上牌を引いた直後にこのコマンドによる思考開始が指示されます。
この時にエンジンができる行動は`dahai`,`reach`,`dkong`,`kkong`,`tsumoagari`,`nuki`です。

#### `go hassei`
```
go hassei <timeoptions>
```

他人が副露や打牌をしたときの思考開始を指示します。
この時にエンジンができる行動は`pong`,`lkong`,`chow`,`ron`,`none`です。
何もしないとき、何もできない時は必ず`none`を返してください。



