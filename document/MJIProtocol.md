# MJProtocol
version:0.0.0

last update:2022/07/09

author:Naka

## これは何？
MahJong Interface Protocol(以下、MJIと略記)は、MahjongStationと思考エンジンの間でやり取りをするプロトコルとして策定されたものです。

コマンドの仕様設計について、[USI](http://shogidokoro.starfree.jp/usi.html)及び[USI-X](https://yaneuraou.yaneu.com/2022/06/07/standard-communication-protocol-for-games/)を強く参考にしています。



## なぜUSI-Xの拡張としなかったのか
プロトコルの策定段階では、USI-Xの純粋な拡張として設定する予定でした。
しかし、USI-Xの前身であるUSIは将棋向けに開発されており、その一部の仕様が麻雀との親和性が悪いと考えました。麻雀をするうえでより自然な情報のやり取りを行うために、新たなプロトコルを設定することとしました。

例えば、将棋はルールが既に確立されている一方、麻雀ではメジャールールでも複数バリエーション、ローカルを合わせれば非常に多くの種類があります。それらのルールに対する拡張性に乏しいと考えました。
また、麻雀は対局という区切りだけでなく局の区切りも明確に分かれており、

## ルールについて
[別ドキュメント](./MJRules.md)参照のこと。

ここで定義されたルールを実装することを考えます。

## データのやり取りについて
仕様定義にあたってのドラフトです。

エンジン起動時、対局開始前、局の開始前(局と局の間を含む)、対局中、対局終了後の５ステップに分けて考えます。

### エンジン起動時

GUIソフトと、MJIプロトコルエンジンの間でのやりとりを開始する。
自身のエンジンで設定されているオプションを送付して、自分がMJIプロトコルを採用したエンジンであることを伝達します。


### 対局開始前

エンジン毎に設定されるオプションをGUIソフト側から設定します。

対戦の開始前準備が宣言されると、設定されたゲームにおける複数のオプションをエンジン側に伝達します。

最後に自身の着席位置の伝達とともに対局準備完了を問い合わせます。

エンジン側は対応不可能なオプションを検出した場合は対戦拒否を宣言できます。


対応可能であれば対局準備完了を宣言します。


### 局の開始前(局と局の間を含む)

現在のそれぞれの点数、次の局の場(東南)と第何局か、何本場かをそれぞれのプレイヤーに宣言します。
そして、各エンジンに局開始の準備ができているかを問い合わせます。

各エンジンは情報を取得して確認出来たら局開始準備ができていることを宣言します。



### 対局中

自摸番が来た時、局の状況(ドラ、河や副露の情報など)と自身の手牌と自摸牌、残り時間などがコマンドとして与えられます。

これに対して、牌を切る、リーチを宣言する、暗槓・加槓を宣言する、自摸和了を宣言するなど、自分の手番で行える動作をコマンドで宣言します。

ツモ番の人が動作を行った後、ほかのプレイヤーはその動作を行った直後の局の状況を受け取ります。
行える動作があるときはそれに対する動作を宣言します。
ここでの動作は、ロン和了り、搶槓でのロン和了り、ポン、槓、チーなどの発声動作を指します。この時、動作をしない場合も動作をしないことを宣言する必要があります。

動作に応じて、適切な人に次の手番が回ってきます。暗槓・加槓であれば同じ人に、ポンカンチーであれば発声者に、それ以外であれば右隣の人に回ってきます。

ここまでの流れを一回のツモ番で行い、これを繰り返します。


### 対局終了後

対局が終了したことと、プレイヤーの着順、それぞれのプレーヤーの点棒、それぞれのプレーヤーのウマ・オカを含めた最終スコアを宣言して終了


# コマンド定義
ここからは、MJIプロトコルで利用される具体的なコマンドを定義します。一部、拡張における仕様が定義されている場合もあります。

## GUIからエンジンに送られるコマンド

### `mji`
```
mji
```
エンジンが起動した直後に送られるコマンドです。エンジンはこれを受け取ったらすぐに`id`コマンドを返します。必要に応じて`option`コマンドを返し、最後に`mjiok`コマンドを送る必要があります。

### `setoption`
```
setoption name <id> value <x>
```
エンジンのオプションをGUI側から設定するためのオプションです。

`<id>`で指定する名前は、エンジンが起動時に`option`コマンドで返した名前になります。
`value <x>`で、`setoption`時に指定されたタイプの値を返します。

ただし、オプションにはMJIプロトコルで予約されたオプションがいくつか定義されています。

**ここにMJIプロトコル予約オプションの定義が入ります。**

### `gamesetup`
```
gamesetup
```
ゲームの準備を開始することを宣言します。
このコマンドに続けてゲームの設定を`gamerule`コマンドで宣言します。最後に`isready`コマンドを送ってエンジン側の返答を待ちます。
`gamesetup`が送られた後に送られた`gamerule`コマンドのみ有効です。それまでに送られていたコマンドは無視してください。

### `gamerule`
```
gamerule name <id> value <x>
```
対局における様々なルールをエンジン側に伝達します。

**ここに具体的なルールを説明する部分が入る**


### `isready`
```
isready
```
エンジンに、準備ができたかどうかを問い合わせます。準備ができた場合は`readyok`コマンドを、対応できないゲームルールが採用されているために対戦を拒否する場合は`readyng`コマンドを送付します